<!DOCTYPE html>
<html>
  <head>
    <title>Location Finder with Place ID and Place Types</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAFyXLqb4z8kE1HehX-OKdH0hNjGyrLHI&libraries=places&callback=initMap" async defer></script>
    <script>
      var geocoder;
      var map;
      var service;
      var currentLocation = { lat: 0, lng: 0 };

      function initMap() {
        geocoder = new google.maps.Geocoder();
        map = new google.maps.Map(document.createElement('div')); // Map object for PlacesService

        // Get user's current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              document.getElementById('manual-lat').value = currentLocation.lat;
              document.getElementById('manual-lng').value = currentLocation.lng;
              getLocationDetails(currentLocation.lat, currentLocation.lng);
            },
            function () {
              alert('Geolocation failed. Please enter coordinates manually.');
            }
          );
        } else {
          alert('Geolocation is not supported by this browser.');
        }
      }

      // Get location details (Place ID, Place types) for given lat/lng
      function getLocationDetails(lat, lng) {
        var latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };

        // Get address using Geocoder
        geocoder.geocode({ location: latlng }, function (results, status) {
          if (status === 'OK') {
            if (results[0]) {
              displayLocationInfo(results[0]);
            } else {
              alert('No results found.');
            }
          } else {
            alert('Geocoder failed due to: ' + status);
          }
        });

        // Get Place ID and details (types) using PlacesService
        getPlaceIdAndDetails(latlng);
      }

      // Get Place ID and fetch types using the Place Details API
      function getPlaceIdAndDetails(latlng) {
        service = new google.maps.places.PlacesService(map);
        var request = {
          location: latlng,
          radius: '10', // Small radius to get place details around the location
        };

        service.nearbySearch(request, function (results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            var place = results[0];
            document.getElementById('place-id').innerText = place.place_id; // Display Place ID

            // Now fetch place details (types) using the Place ID
            getPlaceDetailsById(place.place_id);
          } else {
            document.getElementById('place-id').innerText = 'No Place ID found for this location.';
          }
        });
      }

      // Use Place ID to get Place Details and display the place types
      function getPlaceDetailsById(placeId) {
        var request = {
          placeId: placeId,
          fields: ['types'],
        };

        service.getDetails(request, function (place, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            displayPlaceTypes(place.types);
          } else {
            document.getElementById('location-types').innerText = 'Place types not found.';
          }
        });
      }

      // Display address
      function displayLocationInfo(location) {
        document.getElementById('location-address').innerText = location.formatted_address;
      }

      // Display place types
      function displayPlaceTypes(types) {
        if (types && types.length > 0) {
          document.getElementById('location-types').innerText = types.join(', ');
        } else {
          document.getElementById('location-types').innerText = 'No place types found.';
        }
      }

      // Handle manual latitude/longitude update
      function manualLocationUpdate(e) {
        e.preventDefault();
        var lat = document.getElementById('manual-lat').value;
        var lng = document.getElementById('manual-lng').value;
        getLocationDetails(lat, lng);
      }

    </script>
    <style>
      #location-info {
        margin-top: 20px;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      #location-details p {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>Location Finder with Place ID and Place Types 2</h1>

    <form onsubmit="manualLocationUpdate(event)">
      <label for="manual-lat">Latitude:</label>
      <input type="text" id="manual-lat" placeholder="Enter Latitude" />

      <label for="manual-lng">Longitude:</label>
      <input type="text" id="manual-lng" placeholder="Enter Longitude" />

      <button type="submit">Update Location</button>
    </form>

    <div id="location-info">
      <h3>Location Details</h3>
      <div id="location-details">
        <p><strong>Address:</strong> <span id="location-address">Waiting for location...</span></p>
        <p><strong>Place ID:</strong> <span id="place-id">Waiting for place ID...</span></p>
        <p><strong>Place Types:</strong> <span id="location-types">Waiting for place types...</span></p>
      </div>
    </div>

    <script>
      window.onload = initMap;
    </script>
  </body>
</html>
